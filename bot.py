import pandas as pd
import numpy as np
from sklearn.linear_model import LinearRegression
from telegram import Update
from telegram.ext import Updater, CommandHandler, CallbackContext

# Ø¶Ø¹ Ø§Ù„Ù€ API Token Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù‡Ù†Ø§
API_TOKEN = '8073238511:AAErQnp5OJNNMhPj-_-U2sUscsIe3_t2qcc'

# 1. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¨Ù†Ø§Ø¡ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
def train_model():
    try:
        # Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù…Ù„Ù
        data = pd.read_csv("crash_data.csv")
        
        # ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        X = data[['Round']]  # Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª: Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆÙ„Ø©
        y = data['Multiplier']  # Ø§Ù„Ù…Ø®Ø±Ø¬Ø§Øª: Ø§Ù„Ù…Ø¶Ø§Ø¹Ù
        
        # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
        model = LinearRegression()
        model.fit(X, y)
        print("ØªÙ… ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¨Ù†Ø¬Ø§Ø­.")
        return model
    except Exception as e:
        print(f"Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬: {e}")
        return None

# ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
model = train_model()

# 2. ØªØ¹Ø±ÙŠÙ Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø¨ÙˆØª
def start(update: Update, context: CallbackContext) -> None:
    update.message.reply_text("Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ ÙÙŠ Ø¨ÙˆØª Ø§Ù„ØªÙ†Ø¨Ø¤ Ø¨Ù„Ø¹Ø¨Ø© Crash! ğŸ®")

def predict(update: Update, context: CallbackContext) -> None:
    if not model:
        update.message.reply_text("Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ØºÙŠØ± Ø¬Ø§Ù‡Ø². ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.")
        return
    
    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    if context.args:
        try:
            round_number = int(context.args[0])
            prediction = model.predict([[round_number]])[0]
            update.message.reply_text(f"Ø§Ù„ØªÙˆÙ‚Ø¹ Ù„Ù„Ø¬ÙˆÙ„Ø© {round_number}: x{round(prediction, 2)}")
        except ValueError:
            update.message.reply_text("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ØµØ­ÙŠØ­.")
        except Exception as e:
            update.message.reply_text(f"Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªÙ†Ø¨Ø¤: {e}")
    else:
        update.message.reply_text("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆÙ„Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø£Ù…Ø±. Ù…Ø«Ø§Ù„: /predict 101")

# 3. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙˆØª
def main():
    updater = Updater(API_TOKEN)

    # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£ÙˆØ§Ù…Ø±
    dispatcher = updater.dispatcher
    dispatcher.add_handler(CommandHandler("start", start))
    dispatcher.add_handler(CommandHandler("predict", predict))

    # ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª
    updater.start_polling()
    print("Ø§Ù„Ø¨ÙˆØª ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¢Ù† ğŸš€")
    updater.idle()

if __name__ == '__main__':
    main()
